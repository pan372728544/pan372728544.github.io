<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Object-C - Runloop | Pan&#39;s Blog</title>
    <meta name="description" content="Just playing around">
    
    
    <link rel="preload" href="/assets/css/0.styles.f637169d.css" as="style"><link rel="preload" href="/assets/js/app.908dfad3.js" as="script"><link rel="preload" href="/assets/js/11.fbbc3d23.js" as="script"><link rel="prefetch" href="/assets/js/10.337b1fe3.js"><link rel="prefetch" href="/assets/js/12.85a2c405.js"><link rel="prefetch" href="/assets/js/13.59074305.js"><link rel="prefetch" href="/assets/js/14.966daf17.js"><link rel="prefetch" href="/assets/js/15.ac446f82.js"><link rel="prefetch" href="/assets/js/16.928714ad.js"><link rel="prefetch" href="/assets/js/17.703cf8f6.js"><link rel="prefetch" href="/assets/js/18.613035e7.js"><link rel="prefetch" href="/assets/js/19.9cadccd2.js"><link rel="prefetch" href="/assets/js/2.e9e429c4.js"><link rel="prefetch" href="/assets/js/20.8b804bb6.js"><link rel="prefetch" href="/assets/js/21.93a312f8.js"><link rel="prefetch" href="/assets/js/22.c43fa6cb.js"><link rel="prefetch" href="/assets/js/23.dd7a6de9.js"><link rel="prefetch" href="/assets/js/24.7b66814a.js"><link rel="prefetch" href="/assets/js/25.8c76c392.js"><link rel="prefetch" href="/assets/js/26.22556371.js"><link rel="prefetch" href="/assets/js/27.7cf975c4.js"><link rel="prefetch" href="/assets/js/28.2088bc31.js"><link rel="prefetch" href="/assets/js/29.b328e730.js"><link rel="prefetch" href="/assets/js/3.fc5cd66f.js"><link rel="prefetch" href="/assets/js/30.72707481.js"><link rel="prefetch" href="/assets/js/31.86032cea.js"><link rel="prefetch" href="/assets/js/32.bf03ba96.js"><link rel="prefetch" href="/assets/js/33.eb49a028.js"><link rel="prefetch" href="/assets/js/34.4a07196d.js"><link rel="prefetch" href="/assets/js/35.7a226b76.js"><link rel="prefetch" href="/assets/js/36.db5eec9a.js"><link rel="prefetch" href="/assets/js/37.cdc338c4.js"><link rel="prefetch" href="/assets/js/38.34a35d7d.js"><link rel="prefetch" href="/assets/js/39.695deec3.js"><link rel="prefetch" href="/assets/js/4.7aa51947.js"><link rel="prefetch" href="/assets/js/40.f1dc7d30.js"><link rel="prefetch" href="/assets/js/41.1d34bbf6.js"><link rel="prefetch" href="/assets/js/42.423d3ca5.js"><link rel="prefetch" href="/assets/js/43.d353af94.js"><link rel="prefetch" href="/assets/js/44.de7ee57e.js"><link rel="prefetch" href="/assets/js/45.a6e7ec4a.js"><link rel="prefetch" href="/assets/js/46.2781428a.js"><link rel="prefetch" href="/assets/js/47.12910615.js"><link rel="prefetch" href="/assets/js/48.ec325e20.js"><link rel="prefetch" href="/assets/js/49.7e6b0e34.js"><link rel="prefetch" href="/assets/js/5.34d295cb.js"><link rel="prefetch" href="/assets/js/50.686eceeb.js"><link rel="prefetch" href="/assets/js/51.813c0a41.js"><link rel="prefetch" href="/assets/js/52.ef636f45.js"><link rel="prefetch" href="/assets/js/53.4c0b4978.js"><link rel="prefetch" href="/assets/js/54.6f9c7b33.js"><link rel="prefetch" href="/assets/js/55.4fc94690.js"><link rel="prefetch" href="/assets/js/56.1999815f.js"><link rel="prefetch" href="/assets/js/57.4678e399.js"><link rel="prefetch" href="/assets/js/58.60bc5f58.js"><link rel="prefetch" href="/assets/js/59.a600a8bd.js"><link rel="prefetch" href="/assets/js/6.dccabf12.js"><link rel="prefetch" href="/assets/js/60.7064c1b5.js"><link rel="prefetch" href="/assets/js/61.321797c3.js"><link rel="prefetch" href="/assets/js/62.29b63639.js"><link rel="prefetch" href="/assets/js/7.46fb0051.js"><link rel="prefetch" href="/assets/js/8.adc2b779.js"><link rel="prefetch" href="/assets/js/9.c180848b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f637169d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Pan's Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Object-C</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/oc/runtime/" class="nav-link router-link-active">Runtime</a></li><li class="dropdown-item"><!----> <a href="/oc/kvo/" class="nav-link">KVO</a></li><li class="dropdown-item"><!----> <a href="/oc/runloop/" class="nav-link">RunLoop</a></li><li class="dropdown-item"><!----> <a href="/oc/other/" class="nav-link">Other</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Swift</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/swift/" class="nav-link">Swift4.2</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">C/C++</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/c/" class="nav-link">C/C++</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Multi-Platform</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Native Group</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/h5/flutter/" class="nav-link">Flutter</a></li><li class="dropdown-subitem"><a href="/h5/swiftui/" class="nav-link">SwiftUI</a></li><li class="dropdown-subitem"><a href="/h5/reactnative/" class="nav-link">React-native</a></li><li class="dropdown-subitem"><a href="/h5/cordova/" class="nav-link">Cordova</a></li><li class="dropdown-subitem"><a href="/h5/weex/" class="nav-link">Weex</a></li></ul></li><li class="dropdown-item"><h4>Web Group</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/h5/html/" class="nav-link">HTML</a></li><li class="dropdown-subitem"><a href="/h5/css/" class="nav-link">CSS</a></li><li class="dropdown-subitem"><a href="/h5/js/" class="nav-link">JS</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/pan372728544" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Object-C</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/oc/runtime/" class="nav-link router-link-active">Runtime</a></li><li class="dropdown-item"><!----> <a href="/oc/kvo/" class="nav-link">KVO</a></li><li class="dropdown-item"><!----> <a href="/oc/runloop/" class="nav-link">RunLoop</a></li><li class="dropdown-item"><!----> <a href="/oc/other/" class="nav-link">Other</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Swift</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/swift/" class="nav-link">Swift4.2</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">C/C++</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/c/" class="nav-link">C/C++</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Multi-Platform</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Native Group</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/h5/flutter/" class="nav-link">Flutter</a></li><li class="dropdown-subitem"><a href="/h5/swiftui/" class="nav-link">SwiftUI</a></li><li class="dropdown-subitem"><a href="/h5/reactnative/" class="nav-link">React-native</a></li><li class="dropdown-subitem"><a href="/h5/cordova/" class="nav-link">Cordova</a></li><li class="dropdown-subitem"><a href="/h5/weex/" class="nav-link">Weex</a></li></ul></li><li class="dropdown-item"><h4>Web Group</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/h5/html/" class="nav-link">HTML</a></li><li class="dropdown-subitem"><a href="/h5/css/" class="nav-link">CSS</a></li><li class="dropdown-subitem"><a href="/h5/js/" class="nav-link">JS</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/pan372728544" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Object-c之isa指针</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Object-c之对象的本质</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Object-c之RunLoop</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/oc/runtime/runloop.html" class="active sidebar-link">Object-C - Runloop</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/oc/runtime/runloop.html#一-runloop简介" class="sidebar-link">一. RunLoop简介</a></li><li class="sidebar-sub-header"><a href="/oc/runtime/runloop.html#二-runloop基本作用：" class="sidebar-link">二. RunLoop基本作用：</a></li><li class="sidebar-sub-header"><a href="/oc/runtime/runloop.html#三-runloop在哪里开启" class="sidebar-link">三. RunLoop在哪里开启</a></li><li class="sidebar-sub-header"><a href="/oc/runtime/runloop.html#五-runloop和线程间的关系" class="sidebar-link">五. RunLoop和线程间的关系</a></li><li class="sidebar-sub-header"><a href="/oc/runtime/runloop.html#六-runloop结构体" class="sidebar-link">六. RunLoop结构体</a></li><li class="sidebar-sub-header"><a href="/oc/runtime/runloop.html#七-详解runloop相关类及作用" class="sidebar-link">七. 详解RunLoop相关类及作用</a></li><li class="sidebar-sub-header"><a href="/oc/runtime/runloop.html#八-runloop处理逻辑" class="sidebar-link">八. RunLoop处理逻辑</a></li><li class="sidebar-sub-header"><a href="/oc/runtime/runloop.html#九-runloop退出" class="sidebar-link">九. RunLoop退出</a></li><li class="sidebar-sub-header"><a href="/oc/runtime/runloop.html#十-runloop应用" class="sidebar-link">十. RunLoop应用</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Object-c之Category</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Object-c之关联对象</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Object-c之Block本质</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="object-c-runloop"><a href="#object-c-runloop" aria-hidden="true" class="header-anchor">#</a> Object-C - Runloop</h1> <ul><li>讲讲 RunLoop，项目中有用到吗？</li> <li>RunLoop内部实现逻辑？</li> <li>Runloop和线程的关系？</li> <li>timer 与 Runloop 的关系？</li> <li>程序中添加每3秒响应一次的NSTimer，当拖动tableview时timer可能无法响应要怎么解决？</li> <li>Runloop 是怎么响应用户操作的， 具体流程是什么样的？</li> <li>说说RunLoop的几种状态？</li> <li>Runloop的mode作用是什么？</li></ul> <h2 id="一-runloop简介"><a href="#一-runloop简介" aria-hidden="true" class="header-anchor">#</a> 一. RunLoop简介</h2> <p>运行循环，在程序运行过程中循环做一些事情，如果没有Runloop程序执行完毕就会立即退出，如果有Runloop程序会一直运行，并且时时刻刻在等待用户的输入操作。RunLoop可以在需要的时候自己跑起来运行，在没有操作的时候就停下来休息。充分节省CPU资源，提高程序性能。</p> <h2 id="二-runloop基本作用："><a href="#二-runloop基本作用：" aria-hidden="true" class="header-anchor">#</a> 二. RunLoop基本作用：</h2> <p>保持程序持续运行，程序一启动就会开一个主线程，主线程一开起来就会跑一个主线程对应的RunLoop,RunLoop保证主线程不会被销毁，也就保证了程序的持续运行</p> <p>处理App中的各种事件（比如：触摸事件，定时器事件，Selector事件等）</p> <p>节省CPU资源，提高程序性能，程序运行起来时，当什么操作都没有做的时候，RunLoop就告诉CPU，现在没有事情做，我要去休息，这时CUP就会将其资源释放出来去做其他的事情，当有事情做的时候RunLoop就会立马起来去做事情
我们先通过API内一张图片来简单看一下RunLoop内部运行原理
<img src="/assets/img/15.2b9a56e3.png" alt>
通过图片可以看出，RunLoop在跑圈过程中，当接收到Input sources 或者 Timer sources时就会交给对应的处理方去处理。当没有事件消息传入的时候，RunLoop就休息了。这里只是简单的理解一下这张图，接下来我们来了解RunLoop对象和其一些相关类，来更深入的理解RunLoop运行流程。</p> <h2 id="三-runloop在哪里开启"><a href="#三-runloop在哪里开启" aria-hidden="true" class="header-anchor">#</a> 三. RunLoop在哪里开启</h2> <p>UIApplicationMain函数内启动了Runloop，程序不会马上退出，而是保持运行状态。因此每一个应用必须要有一个runloop，
我们知道主线程一开起来，就会跑一个和主线程对应的RunLoop，那么RunLoop一定是在程序的入口main函数中开启。</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>int <span class="token function">main</span><span class="token punctuation">(</span>int argc<span class="token punctuation">,</span> char <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    @autoreleasepool <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">UIApplicationMain</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token constant">nil</span><span class="token punctuation">,</span> <span class="token function">NSStringFromClass</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">AppDelegate</span> <span class="token keyword">class</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>进入UIApplicationMain</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token constant">UIKIT_EXTERN</span> int <span class="token function">UIApplicationMain</span><span class="token punctuation">(</span>int argc<span class="token punctuation">,</span> char <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">NSString</span> <span class="token operator">*</span> __nullable principalClassName<span class="token punctuation">,</span> <span class="token builtin">NSString</span> <span class="token operator">*</span> __nullable delegateClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>我们发现它返回的是一个int数，那么我们对main函数做一些修改</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>int <span class="token function">main</span><span class="token punctuation">(</span>int argc<span class="token punctuation">,</span> char <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    @autoreleasepool <span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;开始&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        int re <span class="token operator">=</span> <span class="token function">UIApplicationMain</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token constant">nil</span><span class="token punctuation">,</span> <span class="token function">NSStringFromClass</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token builtin">AppDelegate</span> <span class="token keyword">class</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> re<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>运行程序，我们发现只会打印开始，并不会打印结束，这说明在UIApplicationMain函数中，开启了一个和主线程相关的RunLoop，导致UIApplicationMain不会返回，一直在运行中，也就保证了程序的持续运行。
我们来看到RunLoop的源码</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token comment">// 用DefaultMode启动</span>
void <span class="token function">CFRunLoopRun</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">/* DOES CALLOUT */</span>
    int32_t result<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token function">CFRunLoopRunSpecific</span><span class="token punctuation">(</span><span class="token function">CFRunLoopGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">kCFRunLoopDefaultMode</span><span class="token punctuation">,</span> <span class="token number">1.0e10</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CHECK_FOR_FORK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token constant">kCFRunLoopRunStopped</span> <span class="token operator">!=</span> result <span class="token operator">&amp;&amp;</span> <span class="token constant">kCFRunLoopRunFinished</span> <span class="token operator">!=</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>我们发现RunLoop确实是do while通过判断result的值实现的。因此，我们可以把RunLoop看成一个死循环。如果没有RunLoop，UIApplicationMain函数执行完毕之后将直接返回，也就没有程序持续运行一说了。
四. RunLoop对象</p> <blockquote><p>Fundation框架 （基于CFRunLoopRef的封装）
NSRunLoop对象
CoreFoundation
CFRunLoopRef对象</p></blockquote> <p>因为Fundation框架是基于CFRunLoopRef的一层OC封装，这里我们主要研究CFRunLoopRef源码
如何获得RunLoop对象</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token builtin">Foundation</span>
<span class="token punctuation">[</span><span class="token builtin">NSRunLoop</span> currentRunLoop<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获得当前线程的RunLoop对象</span>
<span class="token punctuation">[</span><span class="token builtin">NSRunLoop</span> mainRunLoop<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 获得主线程的RunLoop对象</span>

<span class="token builtin">Core</span> <span class="token builtin">Foundation</span>
<span class="token function">CFRunLoopGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获得当前线程的RunLoop对象</span>
<span class="token function">CFRunLoopGetMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获得主线程的RunLoop对象</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h2 id="五-runloop和线程间的关系"><a href="#五-runloop和线程间的关系" aria-hidden="true" class="header-anchor">#</a> 五. RunLoop和线程间的关系</h2> <ul><li>每条线程都有唯一的一个与之对应的RunLoop对象</li> <li>RunLoop保存在一个全局的Dictionary里，线程作为key,RunLoop作为value</li> <li>主线程的RunLoop已经自动创建好了，子线程的RunLoop需要主动创建</li> <li>RunLoop在第一次获取时创建，在线程结束时销毁
通过源码查看上述对应</li></ul> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token comment">// 拿到当前Runloop 调用_CFRunLoopGet0</span>
<span class="token builtin">CFRunLoopRef</span> <span class="token function">CFRunLoopGetCurrent</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">CHECK_FOR_FORK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">CFRunLoopRef</span> rl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">CFRunLoopRef</span><span class="token punctuation">)</span><span class="token function">_CFGetTSD</span><span class="token punctuation">(</span>__CFTSDKeyRunLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rl<span class="token punctuation">)</span> <span class="token keyword">return</span> rl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">_CFRunLoopGet0</span><span class="token punctuation">(</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 查看_CFRunLoopGet0方法内部</span>
<span class="token constant">CF_EXPORT</span> <span class="token builtin">CFRunLoopRef</span> <span class="token function">_CFRunLoopGet0</span><span class="token punctuation">(</span>pthread_t t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token constant">kNilPthreadT</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    t <span class="token operator">=</span> <span class="token function">pthread_main_thread_np</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__CFLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loopsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__CFRunLoops<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">__CFUnlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loopsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">CFMutableDictionaryRef</span> dict <span class="token operator">=</span> <span class="token function">CFDictionaryCreateMutable</span><span class="token punctuation">(</span><span class="token constant">kCFAllocatorSystemDefault</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token constant">kCFTypeDictionaryValueCallBacks</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 根据传入的主线程获取主线程对应的RunLoop</span>
    <span class="token builtin">CFRunLoopRef</span> mainLoop <span class="token operator">=</span> <span class="token function">__CFRunLoopCreate</span><span class="token punctuation">(</span><span class="token function">pthread_main_thread_np</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 保存主线程 将主线程-key和RunLoop-Value保存到字典中</span>
    <span class="token function">CFDictionarySetValue</span><span class="token punctuation">(</span>dict<span class="token punctuation">,</span> <span class="token function">pthreadPointer</span><span class="token punctuation">(</span><span class="token function">pthread_main_thread_np</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mainLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">OSAtomicCompareAndSwapPtrBarrier</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> dict<span class="token punctuation">,</span> <span class="token punctuation">(</span>void <span class="token operator">*</span> volatile <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>__CFRunLoops<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">CFRelease</span><span class="token punctuation">(</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">CFRelease</span><span class="token punctuation">(</span>mainLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__CFLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loopsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 从字典里面拿，将线程作为key从字典里获取一个loop</span>
    <span class="token builtin">CFRunLoopRef</span> loop <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">CFRunLoopRef</span><span class="token punctuation">)</span><span class="token function">CFDictionaryGetValue</span><span class="token punctuation">(</span>__CFRunLoops<span class="token punctuation">,</span> <span class="token function">pthreadPointer</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__CFUnlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loopsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 如果loop为空，则创建一个新的loop，所以runloop会在第一次获取的时候创建</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loop<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token builtin">CFRunLoopRef</span> newLoop <span class="token operator">=</span> <span class="token function">__CFRunLoopCreate</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__CFLock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loopsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    loop <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">CFRunLoopRef</span><span class="token punctuation">)</span><span class="token function">CFDictionaryGetValue</span><span class="token punctuation">(</span>__CFRunLoops<span class="token punctuation">,</span> <span class="token function">pthreadPointer</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 创建好之后，以线程为key runloop为value，一对一存储在字典中，下次获取的时候，则直接返回字典内的runloop</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>loop<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token function">CFDictionarySetValue</span><span class="token punctuation">(</span>__CFRunLoops<span class="token punctuation">,</span> <span class="token function">pthreadPointer</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> newLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        loop <span class="token operator">=</span> newLoop<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
        <span class="token comment">// don't release run loops inside the loopsLock, because CFRunLoopDeallocate may end up taking it</span>
        <span class="token function">__CFUnlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>loopsLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CFRelease</span><span class="token punctuation">(</span>newLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_equal</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">_CFSetTSD</span><span class="token punctuation">(</span>__CFTSDKeyRunLoop<span class="token punctuation">,</span> <span class="token punctuation">(</span>void <span class="token operator">*</span><span class="token punctuation">)</span>loop<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> <span class="token function">_CFGetTSD</span><span class="token punctuation">(</span>__CFTSDKeyRunLoopCntr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">_CFSetTSD</span><span class="token punctuation">(</span>__CFTSDKeyRunLoopCntr<span class="token punctuation">,</span> <span class="token punctuation">(</span>void <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token constant">PTHREAD_DESTRUCTOR_ITERATIONS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>void <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>void <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>__CFFinalizeRunLoop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> loop<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br></div></div><p>从上面的代码可以看出，线程和 RunLoop 之间是一一对应的，其关系是保存在一个 Dictionary 里。所以我们创建子线程RunLoop时，只需在子线程中获取当前线程的RunLoop对象即可[NSRunLoop currentRunLoop];如果不获取，那子线程就不会创建与之相关联的RunLoop，并且只能在一个线程的内部获取其 RunLoop
[NSRunLoop currentRunLoop];方法调用时，会先看一下字典里有没有存子线程相对用的RunLoop，如果有则直接返回RunLoop，如果没有则会创建一个，并将与之对应的子线程存入字典中。当线程结束时，RunLoop会被销毁。</p> <h2 id="六-runloop结构体"><a href="#六-runloop结构体" aria-hidden="true" class="header-anchor">#</a> 六. RunLoop结构体</h2> <p>通过源码我们找到__CFRunLoop结构体</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">struct</span> __CFRunLoop <span class="token punctuation">{</span>
    <span class="token builtin">CFRuntimeBase</span> _base<span class="token punctuation">;</span>
    pthread_mutex_t _lock<span class="token punctuation">;</span>          <span class="token comment">/* locked for accessing mode list */</span>
    __CFPort _wakeUpPort<span class="token punctuation">;</span>           <span class="token comment">// used for CFRunLoopWakeUp </span>
    <span class="token builtin">Boolean</span> _unused<span class="token punctuation">;</span>
    volatile _per_run_data <span class="token operator">*</span>_perRunData<span class="token punctuation">;</span>              <span class="token comment">// reset for runs of the run loop</span>
    pthread_t _pthread<span class="token punctuation">;</span>
    uint32_t _winthread<span class="token punctuation">;</span>
    <span class="token builtin">CFMutableSetRef</span> _commonModes<span class="token punctuation">;</span>
    <span class="token builtin">CFMutableSetRef</span> _commonModeItems<span class="token punctuation">;</span>
    <span class="token builtin">CFRunLoopModeRef</span> _currentMode<span class="token punctuation">;</span>
    <span class="token builtin">CFMutableSetRef</span> _modes<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> _block_item <span class="token operator">*</span>_blocks_head<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> _block_item <span class="token operator">*</span>_blocks_tail<span class="token punctuation">;</span>
    <span class="token builtin">CFAbsoluteTime</span> _runTime<span class="token punctuation">;</span>
    <span class="token builtin">CFAbsoluteTime</span> _sleepTime<span class="token punctuation">;</span>
    <span class="token builtin">CFTypeRef</span> _counterpart<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>除一些记录性属性外，主要来看一下以下两个成员变量</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token builtin">CFRunLoopModeRef</span> _currentMode<span class="token punctuation">;</span>
<span class="token builtin">CFMutableSetRef</span> _modes<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>CFRunLoopModeRef 其实是指向__CFRunLoopMode结构体的指针，__CFRunLoopMode结构体源码如下</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>typedef <span class="token keyword">struct</span> __CFRunLoopMode <span class="token operator">*</span><span class="token builtin">CFRunLoopModeRef</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> __CFRunLoopMode <span class="token punctuation">{</span>
    <span class="token builtin">CFRuntimeBase</span> _base<span class="token punctuation">;</span>
    pthread_mutex_t _lock<span class="token punctuation">;</span>  <span class="token comment">/* must have the run loop locked before locking this */</span>
    <span class="token builtin">CFStringRef</span> _name<span class="token punctuation">;</span>
    <span class="token builtin">Boolean</span> _stopped<span class="token punctuation">;</span>
    char _padding<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token builtin">CFMutableSetRef</span> _sources0<span class="token punctuation">;</span>
    <span class="token builtin">CFMutableSetRef</span> _sources1<span class="token punctuation">;</span>
    <span class="token builtin">CFMutableArrayRef</span> _observers<span class="token punctuation">;</span>
    <span class="token builtin">CFMutableArrayRef</span> _timers<span class="token punctuation">;</span>
    <span class="token builtin">CFMutableDictionaryRef</span> _portToV1SourceMap<span class="token punctuation">;</span>
    __CFPortSet _portSet<span class="token punctuation">;</span>
    <span class="token builtin">CFIndex</span> _observerMask<span class="token punctuation">;</span>
#<span class="token keyword">if</span> <span class="token constant">USE_DISPATCH_SOURCE_FOR_TIMERS</span>
    dispatch_source_t _timerSource<span class="token punctuation">;</span>
    dispatch_queue_t _queue<span class="token punctuation">;</span>
    <span class="token builtin">Boolean</span> _timerFired<span class="token punctuation">;</span> <span class="token comment">// set to true by the source when a timer has fired</span>
    <span class="token builtin">Boolean</span> _dispatchTimerArmed<span class="token punctuation">;</span>
#endif
#<span class="token keyword">if</span> <span class="token constant">USE_MK_TIMER_TOO</span>
    mach_port_t _timerPort<span class="token punctuation">;</span>
    <span class="token builtin">Boolean</span> _mkTimerArmed<span class="token punctuation">;</span>
#endif
#<span class="token keyword">if</span> <span class="token constant">DEPLOYMENT_TARGET_WINDOWS</span>
    <span class="token constant">DWORD</span> _msgQMask<span class="token punctuation">;</span>
    void <span class="token punctuation">(</span><span class="token operator">*</span>_msgPump<span class="token punctuation">)</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span><span class="token punctuation">;</span>
#endif
    uint64_t _timerSoftDeadline<span class="token punctuation">;</span> <span class="token comment">/* TSR */</span>
    uint64_t _timerHardDeadline<span class="token punctuation">;</span> <span class="token comment">/* TSR */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>主要查看以下成员变量</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token builtin">CFMutableSetRef</span> _sources0<span class="token punctuation">;</span>
<span class="token builtin">CFMutableSetRef</span> _sources1<span class="token punctuation">;</span>
<span class="token builtin">CFMutableArrayRef</span> _observers<span class="token punctuation">;</span>
<span class="token builtin">CFMutableArrayRef</span> _timers<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>通过上面分析我们知道，CFRunLoopModeRef代表RunLoop的运行模式，一个RunLoop包含若干个Mode，每个Mode又包含若干个Source0/Source1/Timer/Observer，而RunLoop启动时只能选择其中一个Mode作为currentMode。
<strong>Source1/Source0/Timers/Observer分别代表什么</strong></p> <ol><li><p>Source1 : 基于Port的线程间通信</p></li> <li><p>Source0 : 触摸事件，PerformSelectors</p></li></ol> <p>我们通过代码验证触摸事件</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>touchesBegan<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">NSSet</span><span class="token operator">&lt;</span><span class="token builtin">UITouch</span> <span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span>touches withEvent<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">UIEvent</span> <span class="token operator">*</span><span class="token punctuation">)</span>event
<span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;点击了屏幕&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>打断点之后打印堆栈信息，当xcode工具区打印的堆栈信息不全时，可以在控制台通过“bt”指令打印完整的堆栈信息，由堆栈信息中可以发现，触摸事件确实是会触发Source0事件。
<img src="/assets/img/16.cc7681bd.png" alt></p> <p>同样的方式验证performSelector堆栈信息</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token function">dispatch_async</span><span class="token punctuation">(</span><span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> performSelectorOnMainThread<span class="token punctuation">:</span>@<span class="token function">selector</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span> withObject<span class="token punctuation">:</span><span class="token constant">nil</span> waitUntilDone<span class="token punctuation">:</span><span class="token constant">YES</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以发现PerformSelectors同样是触发Source0事件
<img src="/assets/img/17.8ac6eff6.png" alt></p> <ol start="3"><li>Timers : 定时器，NSTimer</li></ol> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token punctuation">[</span><span class="token builtin">NSTimer</span> scheduledTimerWithTimeInterval<span class="token punctuation">:</span><span class="token number">3.0</span> repeats<span class="token punctuation">:</span><span class="token constant">NO</span> block<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span><span class="token builtin">NSTimer</span> <span class="token operator">*</span> _Nonnull timer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;NSTimer ---- timer调用了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="/assets/img/18.ce3e4364.png" alt></p> <ol start="4"><li>Observer : 监听器，用于监听RunLoop的状态</li></ol> <h2 id="七-详解runloop相关类及作用"><a href="#七-详解runloop相关类及作用" aria-hidden="true" class="header-anchor">#</a> 七. 详解RunLoop相关类及作用</h2> <p>通过上面的分析，我们对RunLoop内部结构有了大致的了解，接下来来详细分析RunLoop的相关类。以下为Core Foundation中关于RunLoop的5个类</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <ul><li><p>CFRunLoopRef - 获得当前RunLoop和主RunLoop</p></li> <li><p>CFRunLoopModeRef - RunLoop 运行模式，只能选择一种，在不同模式中做不同的操作</p></li> <li><p>CFRunLoopSourceRef - 事件源，输入源</p></li> <li><p>CFRunLoopTimerRef - 定时器时间</p></li> <li><p>CFRunLoopObserverRef - 观察者</p></li></ul></div> <ol><li>CFRunLoopModeRef
CFRunLoopModeRef代表RunLoop的运行模式
一个 RunLoop 包含若干个 Mode，每个Mode又包含若干个Source、Timer、Observer
每次RunLoop启动时，只能指定其中一个 Mode，这个Mode被称作 CurrentMode
如果需要切换Mode，只能退出RunLoop，再重新指定一个Mode进入，这样做主要是为了分隔开不同组的Source、Timer、Observer，让其互不影响。如果Mode里没有任何Source0/Source1/Timer/Observer，RunLoop会立马退出
如图所示：
<img src="/assets/img/19.de3186c6.png" alt>
注意：一种Mode中可以有多个Source(事件源，输入源，基于端口事件源例键盘触摸等) Observer(观察者，观察当前RunLoop运行状态) 和Timer(定时器事件源)。但是必须至少有一个Source或者Timer，因为如果Mode为空，RunLoop运行到空模式不会进行空转，就会立刻退出。</li></ol> <p>**系统默认注册的5个Mode:</p> <p>RunLoop 有五种运行模式，其中常见的有1.2两种</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <ol><li>kCFRunLoopDefaultMode：App的默认Mode，通常主线程是在这个Mode下运行</li> <li>UITrackingRunLoopMode：界面跟踪 Mode，用于 ScrollView 追踪触摸滑动，保证界面滑动时不受其他 Mode 影响</li> <li>UIInitializationRunLoopMode: 在刚启动 App 时第进入的第一个 Mode，启动完成后就不再使用，会切换到kCFRunLoopDefaultMode</li> <li>GSEventReceiveRunLoopMode: 接受系统事件的内部 Mode，通常用不到</li> <li>kCFRunLoopCommonModes: 这是一个占位用的Mode，作为标记kCFRunLoopDefaultMode和UITrackingRunLoopMode用，并不是一种真正的Mode</li></ol></div> <p><strong>Mode间的切换</strong></p> <p>我们平时在开发中一定遇到过，当我们使用NSTimer每一段时间执行一些事情时滑动UIScrollView，NSTimer就会暂停，当我们停止滑动以后，NSTimer又会重新恢复的情况，我们通过一段代码来看一下
代码中的注释也很重要，展示了我们探索的过程</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token operator">-</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span>touchesBegan<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">NSSet</span><span class="token operator">&lt;</span><span class="token builtin">UITouch</span> <span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span>touches withEvent<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">UIEvent</span> <span class="token operator">*</span><span class="token punctuation">)</span>event
<span class="token punctuation">{</span>
    <span class="token comment">// [NSTimer scheduledTimerWithTimeInterval:2.0 target:self selector:@selector(show) userInfo:nil repeats:YES];</span>
    <span class="token builtin">NSTimer</span> <span class="token operator">*</span>timer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">NSTimer</span> timerWithTimeInterval<span class="token punctuation">:</span><span class="token number">2.0</span> target<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span>@<span class="token function">selector</span><span class="token punctuation">(</span>show<span class="token punctuation">)</span> userInfo<span class="token punctuation">:</span><span class="token constant">nil</span> repeats<span class="token punctuation">:</span><span class="token constant">YES</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 加入到RunLoop中才可以运行</span>
    <span class="token comment">// 1. 把定时器添加到RunLoop中，并且选择默认运行模式NSDefaultRunLoopMode = kCFRunLoopDefaultMode</span>
    <span class="token comment">// [[NSRunLoop mainRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];</span>
    <span class="token comment">// 当textFiled滑动的时候，timer失效，停止滑动时，timer恢复</span>
    <span class="token comment">// 原因：当textFiled滑动的时候，RunLoop的Mode会自动切换成UITrackingRunLoopMode模式，因此timer失效，当停止滑动，RunLoop又会切换回NSDefaultRunLoopMode模式，因此timer又会重新启动了</span>
    
    <span class="token comment">// 2. 当我们将timer添加到UITrackingRunLoopMode模式中，此时只有我们在滑动textField时timer才会运行</span>
    <span class="token comment">// [[NSRunLoop mainRunLoop] addTimer:timer forMode:UITrackingRunLoopMode];</span>
    
    <span class="token comment">// 3. 那个如何让timer在两个模式下都可以运行呢？</span>
    <span class="token comment">// 3.1 在两个模式下都添加timer 是可以的，但是timer添加了两次，并不是同一个timer</span>
    <span class="token comment">// 3.2 使用站位的运行模式 NSRunLoopCommonModes标记，凡是被打上NSRunLoopCommonModes标记的都可以运行，下面两种模式被打上标签</span>
    <span class="token comment">//0 : &lt;CFString 0x10b7fe210 [0x10a8c7a40]&gt;{contents = &quot;UITrackingRunLoopMode&quot;}</span>
    <span class="token comment">//2 : &lt;CFString 0x10a8e85e0 [0x10a8c7a40]&gt;{contents = &quot;kCFRunLoopDefaultMode&quot;}</span>
    <span class="token comment">// 因此也就是说如果我们使用NSRunLoopCommonModes，timer可以在UITrackingRunLoopMode，kCFRunLoopDefaultMode两种模式下运行</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">NSRunLoop</span> mainRunLoop<span class="token punctuation">]</span> addTimer<span class="token punctuation">:</span>timer forMode<span class="token punctuation">:</span><span class="token builtin">NSRunLoopCommonModes</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token builtin">NSRunLoop</span> mainRunLoop<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span>show
<span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;-------&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>由上述代码可以看出，NSTimer不管用是因为Mode的切换，因为如果我们在主线程使用定时器，此时RunLoop的Mode为kCFRunLoopDefaultMode，即定时器属于kCFRunLoopDefaultMode，那么此时我们滑动ScrollView时，RunLoop的Mode会切换到UITrackingRunLoopMode，因此在主线程的定时器就不在管用了，调用的方法也就不再执行了，当我们停止滑动时，RunLoop的Mode切换回kCFRunLoopDefaultMode，所以NSTimer就又管用了。
同样道理的还有ImageView的显示，我们直接来看代码，不再赘述了</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token operator">-</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span>touchesBegan<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">NSSet</span><span class="token operator">&lt;</span><span class="token builtin">UITouch</span> <span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span>touches withEvent<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">UIEvent</span> <span class="token operator">*</span><span class="token punctuation">)</span>event
<span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span>__func__<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// performSelector默认是在default模式下运行，因此在滑动ScrollView时，图片不会加载</span>
    <span class="token comment">// [self.imageView performSelector:@selector(setImage:) withObject:[UIImage imageNamed:@&quot;abc&quot;] afterDelay:2.0 ];</span>
    <span class="token comment">// inModes: 传入Mode数组</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span><span class="token punctuation">.</span>imageView performSelector<span class="token punctuation">:</span>@<span class="token function">selector</span><span class="token punctuation">(</span>setImage<span class="token punctuation">:</span><span class="token punctuation">)</span> withObject<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token builtin">UIImage</span> imageNamed<span class="token punctuation">:</span>@<span class="token string">&quot;abc&quot;</span><span class="token punctuation">]</span> afterDelay<span class="token punctuation">:</span><span class="token number">2.0</span> inModes<span class="token punctuation">:</span>@<span class="token punctuation">[</span><span class="token builtin">NSDefaultRunLoopMode</span><span class="token punctuation">,</span><span class="token builtin">UITrackingRunLoopMode</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>使用GCD也可是创建计时器，而且更为精确我们来看一下代码</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token operator">-</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span>touchesBegan<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">NSSet</span><span class="token operator">&lt;</span><span class="token builtin">UITouch</span> <span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span>touches withEvent<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">UIEvent</span> <span class="token operator">*</span><span class="token punctuation">)</span>event
<span class="token punctuation">{</span>
    <span class="token comment">//创建队列</span>
    dispatch_queue_t queue <span class="token operator">=</span> <span class="token function">dispatch_get_global_queue</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//1.创建一个GCD定时器</span>
    <span class="token comment">/*
     第一个参数:表明创建的是一个定时器
     第四个参数:队列
     */</span>
    dispatch_source_t timer <span class="token operator">=</span> <span class="token function">dispatch_source_create</span><span class="token punctuation">(</span><span class="token constant">DISPATCH_SOURCE_TYPE_TIMER</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 需要对timer进行强引用，保证其不会被释放掉，才会按时调用block块</span>
    <span class="token comment">// 局部变量，让指针强引用</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> timer<span class="token punctuation">;</span>
    <span class="token comment">//2.设置定时器的开始时间,间隔时间,精准度</span>
    <span class="token comment">/*
     第1个参数:要给哪个定时器设置
     第2个参数:开始时间
     第3个参数:间隔时间
     第4个参数:精准度 一般为0 在允许范围内增加误差可提高程序的性能
     GCD的单位是纳秒 所以要*NSEC_PER_SEC
     */</span>
    <span class="token function">dispatch_source_set_timer</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> <span class="token constant">DISPATCH_TIME_NOW</span><span class="token punctuation">,</span> <span class="token number">2.0</span> <span class="token operator">*</span> <span class="token constant">NSEC_PER_SEC</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token operator">*</span> <span class="token constant">NSEC_PER_SEC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//3.设置定时器要执行的事情</span>
    <span class="token function">dispatch_source_set_event_handler</span><span class="token punctuation">(</span>timer<span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">{</span>
        <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;---%@--&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token builtin">NSThread</span> currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动</span>
    <span class="token function">dispatch_resume</span><span class="token punctuation">(</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><ol start="2"><li>CFRunLoopSourceRef事件源（输入源）
Source分为两种</li></ol> <ul><li>Source0：非基于Port的 用于用户主动触发的事件（点击button 或点击屏幕）</li> <li>Source1：基于Port的  通过内核和其他线程相互发送消息（与内核相关）</li></ul> <p>触摸事件及PerformSelectors会触发Source0事件源在前文已经验证过，这里不在赘述</p> <ol start="3"><li>CFRunLoopObserverRef
CFRunLoopObserverRef是观察者，能够监听RunLoop的状态改变
我们直接来看代码，给RunLoop添加监听者，监听其运行状态</li></ol> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token operator">-</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span>touchesBegan<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">NSSet</span><span class="token operator">&lt;</span><span class="token builtin">UITouch</span> <span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span>touches withEvent<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">UIEvent</span> <span class="token operator">*</span><span class="token punctuation">)</span>event
<span class="token punctuation">{</span>
     <span class="token comment">//创建监听者</span>
     <span class="token comment">/*
     第一个参数 CFAllocatorRef allocator：分配存储空间 CFAllocatorGetDefault()默认分配
     第二个参数 CFOptionFlags activities：要监听的状态 kCFRunLoopAllActivities 监听所有状态
     第三个参数 Boolean repeats：YES:持续监听 NO:不持续
     第四个参数 CFIndex order：优先级，一般填0即可
     第五个参数 ：回调 两个参数observer:监听者 activity:监听的事件
     */</span>
     <span class="token comment">/*
     所有事件
     typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) {
     kCFRunLoopEntry = (1UL &lt;&lt; 0),   //   即将进入RunLoop
     kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1), // 即将处理Timer
     kCFRunLoopBeforeSources = (1UL &lt;&lt; 2), // 即将处理Source
     kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5), //即将进入休眠
     kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6),// 刚从休眠中唤醒
     kCFRunLoopExit = (1UL &lt;&lt; 7),// 即将退出RunLoop
     kCFRunLoopAllActivities = 0x0FFFFFFFU
     };
     */</span>
    <span class="token builtin">CFRunLoopObserverRef</span> observer <span class="token operator">=</span> <span class="token function">CFRunLoopObserverCreateWithHandler</span><span class="token punctuation">(</span><span class="token function">CFAllocatorGetDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">kCFRunLoopAllActivities</span><span class="token punctuation">,</span> <span class="token constant">YES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token builtin">CFRunLoopObserverRef</span> observer<span class="token punctuation">,</span> <span class="token builtin">CFRunLoopActivity</span> activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopEntry</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop进入&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopBeforeTimers</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop要处理Timers了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopBeforeSources</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop要处理Sources了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopBeforeWaiting</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop要休息了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopAfterWaiting</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop醒来了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopExit</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop退出了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
                
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 给RunLoop添加监听者</span>
    <span class="token comment">/*
     第一个参数 CFRunLoopRef rl：要监听哪个RunLoop,这里监听的是主线程的RunLoop
     第二个参数 CFRunLoopObserverRef observer 监听者
     第三个参数 CFStringRef mode 要监听RunLoop在哪种运行模式下的状态
     */</span>
    <span class="token function">CFRunLoopAddObserver</span><span class="token punctuation">(</span><span class="token function">CFRunLoopGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> observer<span class="token punctuation">,</span> <span class="token constant">kCFRunLoopDefaultMode</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">/*
     CF的内存管理（Core Foundation）
     凡是带有Create、Copy、Retain等字眼的函数，创建出来的对象，都需要在最后做一次release
     GCD本来在iOS6.0之前也是需要我们释放的，6.0之后GCD已经纳入到了ARC中，所以我们不需要管了
     */</span>
    <span class="token function">CFRelease</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br></div></div><p>我们来看一下输出</p> <p><img src="/assets/img/20.d2dd4681.png" alt></p> <p>以上可以看出，Observer确实用来监听RunLoop的状态，包括唤醒，休息，以及处理各种事件。</p> <h2 id="八-runloop处理逻辑"><a href="#八-runloop处理逻辑" aria-hidden="true" class="header-anchor">#</a> 八. RunLoop处理逻辑</h2> <p>这时我们再来分析RunLoop的处理逻辑，就会简单明了很多，现在回头看官方文档RunLoop的处理逻辑，对RunLoop的处理逻辑有新的认识。
<img src="/assets/img/15.2b9a56e3.png" alt> <strong>源码解析</strong></p> <p>下面源码仅保留了主流程代码</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token comment">// 共外部调用的公开的CFRunLoopRun方法，其内部会调用CFRunLoopRunSpecific</span>
void <span class="token function">CFRunLoopRun</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span> <span class="token punctuation">{</span>   <span class="token comment">/* DOES CALLOUT */</span>
    int32_t result<span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        result <span class="token operator">=</span> <span class="token function">CFRunLoopRunSpecific</span><span class="token punctuation">(</span><span class="token function">CFRunLoopGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">kCFRunLoopDefaultMode</span><span class="token punctuation">,</span> <span class="token number">1.0e10</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CHECK_FOR_FORK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token constant">kCFRunLoopRunStopped</span> <span class="token operator">!=</span> result <span class="token operator">&amp;&amp;</span> <span class="token constant">kCFRunLoopRunFinished</span> <span class="token operator">!=</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 经过精简的 CFRunLoopRunSpecific 函数代码，其内部会调用__CFRunLoopRun函数</span>
<span class="token builtin">SInt32</span> <span class="token function">CFRunLoopRunSpecific</span><span class="token punctuation">(</span><span class="token builtin">CFRunLoopRef</span> rl<span class="token punctuation">,</span> <span class="token builtin">CFStringRef</span> modeName<span class="token punctuation">,</span> <span class="token builtin">CFTimeInterval</span> seconds<span class="token punctuation">,</span> <span class="token builtin">Boolean</span> returnAfterSourceHandled<span class="token punctuation">)</span> <span class="token punctuation">{</span>     <span class="token comment">/* DOES CALLOUT */</span>

    <span class="token comment">// 通知Observers : 进入Loop</span>
    <span class="token comment">// __CFRunLoopDoObservers内部会调用 __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__</span>
函数
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMode<span class="token operator">-</span><span class="token operator">&gt;</span>_observerMask <span class="token operator">&amp;</span> <span class="token constant">kCFRunLoopEntry</span> <span class="token punctuation">)</span> <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> <span class="token constant">kCFRunLoopEntry</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 核心的Loop逻辑</span>
    result <span class="token operator">=</span> <span class="token function">__CFRunLoopRun</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> seconds<span class="token punctuation">,</span> returnAfterSourceHandled<span class="token punctuation">,</span> previousMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 通知Observers : 退出Loop</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentMode<span class="token operator">-</span><span class="token operator">&gt;</span>_observerMask <span class="token operator">&amp;</span> <span class="token constant">kCFRunLoopExit</span> <span class="token punctuation">)</span> <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> currentMode<span class="token punctuation">,</span> <span class="token constant">kCFRunLoopExit</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 精简后的 __CFRunLoopRun函数，保留了主要代码</span>
<span class="token keyword">static</span> int32_t <span class="token function">__CFRunLoopRun</span><span class="token punctuation">(</span><span class="token builtin">CFRunLoopRef</span> rl<span class="token punctuation">,</span> <span class="token builtin">CFRunLoopModeRef</span> rlm<span class="token punctuation">,</span> <span class="token builtin">CFTimeInterval</span> seconds<span class="token punctuation">,</span> <span class="token builtin">Boolean</span> stopAfterHandle<span class="token punctuation">,</span> <span class="token builtin">CFRunLoopModeRef</span> previousMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    int32_t retVal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通知Observers：即将处理Timers</span>
        <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> <span class="token constant">kCFRunLoopBeforeTimers</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        
        <span class="token comment">// 通知Observers：即将处理Sources</span>
        <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> <span class="token constant">kCFRunLoopBeforeSources</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 处理Blocks</span>
        <span class="token function">__CFRunLoopDoBlocks</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 处理Sources0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopDoSources0</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> stopAfterHandle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理Blocks</span>
            <span class="token function">__CFRunLoopDoBlocks</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 如果有Sources1，就跳转到handle_msg标记处</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopServiceMachPort</span><span class="token punctuation">(</span>dispatchPort<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>msg_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>livePort<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>voucherState<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            goto handle_msg<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 通知Observers：即将休眠</span>
        <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> <span class="token constant">kCFRunLoopBeforeWaiting</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 进入休眠，等待其他消息唤醒</span>
        <span class="token function">__CFRunLoopSetSleeping</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__CFPortSetInsert</span><span class="token punctuation">(</span>dispatchPort<span class="token punctuation">,</span> waitSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            <span class="token function">__CFRunLoopServiceMachPort</span><span class="token punctuation">(</span>waitSet<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token function">sizeof</span><span class="token punctuation">(</span>msg_buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>livePort<span class="token punctuation">,</span> poll <span class="token operator">?</span> <span class="token number">0</span> <span class="token punctuation">:</span> <span class="token constant">TIMEOUT_INFINITY</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>voucherState<span class="token punctuation">,</span> <span class="token operator">&amp;</span>voucherCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 醒来</span>
        <span class="token function">__CFPortSetRemove</span><span class="token punctuation">(</span>dispatchPort<span class="token punctuation">,</span> waitSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__CFRunLoopUnsetSleeping</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 通知Observers：已经唤醒</span>
        <span class="token function">__CFRunLoopDoObservers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> <span class="token constant">kCFRunLoopAfterWaiting</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    handle_msg<span class="token punctuation">:</span> <span class="token comment">// 看看是谁唤醒了RunLoop，进行相应的处理</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>被<span class="token builtin">Timer</span>唤醒的<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 处理Timer</span>
            <span class="token function">__CFRunLoopDoTimers</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> <span class="token function">mach_absolute_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>被<span class="token constant">GCD</span>唤醒的<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 被Sources1唤醒的</span>
            <span class="token function">__CFRunLoopDoSource1</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> rls<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> msg<span class="token operator">-</span><span class="token operator">&gt;</span>msgh_size<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reply<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 执行Blocks</span>
        <span class="token function">__CFRunLoopDoBlocks</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 根据之前的执行结果，来决定怎么做，为retVal赋相应的值</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sourceHandledThisLoop <span class="token operator">&amp;&amp;</span> stopAfterHandle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            retVal <span class="token operator">=</span> <span class="token constant">kCFRunLoopRunHandledSource</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout_context<span class="token operator">-</span><span class="token operator">&gt;</span>termTSR <span class="token operator">&lt;</span> <span class="token function">mach_absolute_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            retVal <span class="token operator">=</span> <span class="token constant">kCFRunLoopRunTimedOut</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopIsStopped</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">__CFRunLoopUnsetStopped</span><span class="token punctuation">(</span>rl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            retVal <span class="token operator">=</span> <span class="token constant">kCFRunLoopRunStopped</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rlm<span class="token operator">-</span><span class="token operator">&gt;</span>_stopped<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rlm<span class="token operator">-</span><span class="token operator">&gt;</span>_stopped <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            retVal <span class="token operator">=</span> <span class="token constant">kCFRunLoopRunStopped</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__CFRunLoopModeIsEmpty</span><span class="token punctuation">(</span>rl<span class="token punctuation">,</span> rlm<span class="token punctuation">,</span> previousMode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            retVal <span class="token operator">=</span> <span class="token constant">kCFRunLoopRunFinished</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">==</span> retVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> retVal<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br></div></div><p>上述源代码中，相应处理事件函数内部还会调用更底层的函数，内部调用才是真正处理事件的函数，通过上面bt打印全部堆栈信息也可以得到验证。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>__CFRunLoopDoObservers 内部调用 <strong>CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION</strong></p> <p>__CFRunLoopDoBlocks 内部调用 <strong>CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK</strong></p> <p>__CFRunLoopDoSources0 内部调用 <strong>CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION</strong></p> <p>__CFRunLoopDoTimers 内部调用 <strong>CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION</strong></p> <p>GCD 调用 <strong>CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE</strong></p> <p>__CFRunLoopDoSource1 内部调用 <strong>CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION</strong></p></div> <p><strong>RunLoop处理逻辑流程图</strong></p> <p>此时我们按照源码重新整理一下RunLoop处理逻辑就会很清晰
<img src="/assets/img/21.35e19aeb.png" alt></p> <h2 id="九-runloop退出"><a href="#九-runloop退出" aria-hidden="true" class="header-anchor">#</a> 九. RunLoop退出</h2> <p>主线程销毁RunLoop退出
Mode中有一些Timer 、Source、 Observer，这些保证Mode不为空时保证RunLoop没有空转并且是在运行的，当Mode中为空的时候，RunLoop会立刻退出
我们在启动RunLoop的时候可以设置什么时候停止</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token punctuation">[</span><span class="token builtin">NSRunLoop</span> currentRunLoop<span class="token punctuation">]</span>runUntilDate<span class="token punctuation">:</span><span class="token operator">&lt;</span>#<span class="token punctuation">(</span>nonnull <span class="token builtin">NSDate</span> <span class="token operator">*</span><span class="token punctuation">)</span>#<span class="token operator">&gt;</span>
<span class="token punctuation">[</span><span class="token builtin">NSRunLoop</span> currentRunLoop<span class="token punctuation">]</span>runMode<span class="token punctuation">:</span><span class="token operator">&lt;</span>#<span class="token punctuation">(</span>nonnull <span class="token builtin">NSString</span> <span class="token operator">*</span><span class="token punctuation">)</span>#<span class="token operator">&gt;</span> beforeDate<span class="token punctuation">:</span><span class="token operator">&lt;</span>#<span class="token punctuation">(</span>nonnull <span class="token builtin">NSDate</span> <span class="token operator">*</span><span class="token punctuation">)</span>#<span class="token operator">&gt;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="十-runloop应用"><a href="#十-runloop应用" aria-hidden="true" class="header-anchor">#</a> 十. RunLoop应用</h2> <ol><li>常驻线程
常驻线程的作用：我们知道，当子线程中的任务执行完毕之后就被销毁了，那么如果我们需要开启一个子线程，在程序运行过程中永远都存在，那么我们就会面临一个问题，如何让子线程永远活着，这时就要用到常驻线程：给子线程开启一个RunLoop
注意：子线程执行完操作之后就会立即释放，即使我们使用强引用引用子线程使子线程不被释放，也不能给子线程再次添加操作，或者再次开启。
子线程开启RunLoop的代码，先点击屏幕开启子线程并开启子线程RunLoop，然后点击button。</li></ol> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>#<span class="token keyword">import</span> <span class="token string">&quot;ViewController.h&quot;</span>

@interface <span class="token class-name">ViewController</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
@<span class="token function">property</span><span class="token punctuation">(</span>nonatomic<span class="token punctuation">,</span>strong<span class="token punctuation">)</span><span class="token builtin">NSThread</span> <span class="token operator">*</span>thread<span class="token punctuation">;</span>

@end

@implementation <span class="token builtin">ViewController</span>

<span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span>touchesBegan<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">NSSet</span><span class="token operator">&lt;</span><span class="token builtin">UITouch</span> <span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token punctuation">)</span>touches withEvent<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">UIEvent</span> <span class="token operator">*</span><span class="token punctuation">)</span>event
<span class="token punctuation">{</span>
   <span class="token comment">// 创建子线程并开启</span>
    <span class="token builtin">NSThread</span> <span class="token operator">*</span>thread <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">NSThread</span> alloc<span class="token punctuation">]</span>initWithTarget<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span>@<span class="token function">selector</span><span class="token punctuation">(</span>show<span class="token punctuation">)</span> object<span class="token punctuation">:</span><span class="token constant">nil</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">self</span><span class="token punctuation">.</span>thread <span class="token operator">=</span> thread<span class="token punctuation">;</span>
    <span class="token punctuation">[</span>thread start<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span>show
<span class="token punctuation">{</span>
    <span class="token comment">// 注意：打印方法一定要在RunLoop创建开始运行之前，如果在RunLoop跑起来之后打印，RunLoop先运行起来，已经在跑圈了就出不来了，进入死循环也就无法执行后面的操作了。</span>
    <span class="token comment">// 但是此时点击Button还是有操作的，因为Button是在RunLoop跑起来之后加入到子线程的，当Button加入到子线程RunLoop就会跑起来</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;%s&quot;</span><span class="token punctuation">,</span>__func__<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 1.创建子线程相关的RunLoop，在子线程中创建即可，并且RunLoop中要至少有一个Timer 或 一个Source 保证RunLoop不会因为空转而退出，因此在创建的时候直接加入</span>
    <span class="token comment">// 添加Source [NSMachPort port] 添加一个端口</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">NSRunLoop</span> currentRunLoop<span class="token punctuation">]</span> addPort<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token builtin">NSMachPort</span> port<span class="token punctuation">]</span> forMode<span class="token punctuation">:</span><span class="token builtin">NSDefaultRunLoopMode</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 添加一个Timer</span>
    <span class="token builtin">NSTimer</span> <span class="token operator">*</span>timer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">NSTimer</span> scheduledTimerWithTimeInterval<span class="token punctuation">:</span><span class="token number">2.0</span> target<span class="token punctuation">:</span><span class="token keyword">self</span> selector<span class="token punctuation">:</span>@<span class="token function">selector</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span> userInfo<span class="token punctuation">:</span><span class="token constant">nil</span> repeats<span class="token punctuation">:</span><span class="token constant">YES</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">NSRunLoop</span> currentRunLoop<span class="token punctuation">]</span> addTimer<span class="token punctuation">:</span>timer forMode<span class="token punctuation">:</span><span class="token builtin">NSDefaultRunLoopMode</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    
    <span class="token comment">//创建监听者</span>
    <span class="token builtin">CFRunLoopObserverRef</span> observer <span class="token operator">=</span> <span class="token function">CFRunLoopObserverCreateWithHandler</span><span class="token punctuation">(</span><span class="token function">CFAllocatorGetDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">kCFRunLoopAllActivities</span><span class="token punctuation">,</span> <span class="token constant">YES</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">^</span><span class="token punctuation">(</span><span class="token builtin">CFRunLoopObserverRef</span> observer<span class="token punctuation">,</span> <span class="token builtin">CFRunLoopActivity</span> activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>activity<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopEntry</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop进入&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopBeforeTimers</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop要处理Timers了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopBeforeSources</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop要处理Sources了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopBeforeWaiting</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop要休息了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopAfterWaiting</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop醒来了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token constant">kCFRunLoopExit</span><span class="token punctuation">:</span>
                <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;RunLoop退出了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 给RunLoop添加监听者</span>
    <span class="token function">CFRunLoopAddObserver</span><span class="token punctuation">(</span><span class="token function">CFRunLoopGetCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> observer<span class="token punctuation">,</span> <span class="token constant">kCFRunLoopDefaultMode</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.子线程需要开启RunLoop</span>
    <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">NSRunLoop</span> currentRunLoop<span class="token punctuation">]</span>run<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">CFRelease</span><span class="token punctuation">(</span>observer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token builtin">IBAction</span><span class="token punctuation">)</span>btnClick<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>sender <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> performSelector<span class="token punctuation">:</span>@<span class="token function">selector</span><span class="token punctuation">(</span>test<span class="token punctuation">)</span> onThread<span class="token punctuation">:</span><span class="token keyword">self</span><span class="token punctuation">.</span>thread withObject<span class="token punctuation">:</span><span class="token constant">nil</span> waitUntilDone<span class="token punctuation">:</span><span class="token constant">NO</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span><span class="token punctuation">(</span>void<span class="token punctuation">)</span>test
<span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;%@&quot;</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token builtin">NSThread</span> currentThread<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@end
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>注意：创建子线程相关的RunLoop，在子线程中创建即可，并且RunLoop中要至少有一个Timer 或 一个Source 保证RunLoop不会因为空转而退出，因此在创建的时候直接加入，如果没有加入Timer或者Source，或者只加入一个监听者，运行程序会崩溃</p></div> <ol start="2"><li>自动释放池
Timer和Source也是一些变量，需要占用一部分存储空间，所以要释放掉，如果不释放掉，就会一直积累，占用的内存也就越来越大，这显然不是我们想要的。
那么什么时候释放，怎么释放呢？
RunLoop内部有一个自动释放池，当RunLoop开启时，就会自动创建一个自动释放池，当RunLoop在休息之前会释放掉自动释放池的东西，然后重新创建一个新的空的自动释放池，当RunLoop被唤醒重新开始跑圈时，Timer,Source等新的事件就会放到新的自动释放池中，当RunLoop退出的时候也会被释放。
注意：只有主线程的RunLoop会默认启动。也就意味着会自动创建自动释放池，子线程需要在线程调度方法中手动添加自动释放池。</li></ol> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code>@autorelease<span class="token punctuation">{</span>  
      <span class="token comment">// 执行代码 </span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>NSTimer、ImageView显示、PerformSelector等在上面已经有过例子，这里不再赘述。</p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">1/3/2019, 3:02:36 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/oc/runtime/instance2.html" class="prev">
          Object-C - 对象的本质(下)
        </a></span> <span class="next"><a href="/oc/runtime/category.html">
          Object-C - Category的本质
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.908dfad3.js" defer></script><script src="/assets/js/11.fbbc3d23.js" defer></script>
  </body>
</html>
