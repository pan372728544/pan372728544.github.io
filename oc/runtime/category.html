<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Object-C - Category的本质 | Pan&#39;s Blog</title>
    <meta name="description" content="Just playing around">
    
    
    <link rel="preload" href="/assets/css/0.styles.f637169d.css" as="style"><link rel="preload" href="/assets/js/app.908dfad3.js" as="script"><link rel="preload" href="/assets/js/3.fc5cd66f.js" as="script"><link rel="prefetch" href="/assets/js/10.337b1fe3.js"><link rel="prefetch" href="/assets/js/11.fbbc3d23.js"><link rel="prefetch" href="/assets/js/12.85a2c405.js"><link rel="prefetch" href="/assets/js/13.59074305.js"><link rel="prefetch" href="/assets/js/14.966daf17.js"><link rel="prefetch" href="/assets/js/15.ac446f82.js"><link rel="prefetch" href="/assets/js/16.928714ad.js"><link rel="prefetch" href="/assets/js/17.703cf8f6.js"><link rel="prefetch" href="/assets/js/18.613035e7.js"><link rel="prefetch" href="/assets/js/19.9cadccd2.js"><link rel="prefetch" href="/assets/js/2.e9e429c4.js"><link rel="prefetch" href="/assets/js/20.8b804bb6.js"><link rel="prefetch" href="/assets/js/21.93a312f8.js"><link rel="prefetch" href="/assets/js/22.c43fa6cb.js"><link rel="prefetch" href="/assets/js/23.dd7a6de9.js"><link rel="prefetch" href="/assets/js/24.7b66814a.js"><link rel="prefetch" href="/assets/js/25.8c76c392.js"><link rel="prefetch" href="/assets/js/26.22556371.js"><link rel="prefetch" href="/assets/js/27.7cf975c4.js"><link rel="prefetch" href="/assets/js/28.2088bc31.js"><link rel="prefetch" href="/assets/js/29.b328e730.js"><link rel="prefetch" href="/assets/js/30.72707481.js"><link rel="prefetch" href="/assets/js/31.86032cea.js"><link rel="prefetch" href="/assets/js/32.bf03ba96.js"><link rel="prefetch" href="/assets/js/33.eb49a028.js"><link rel="prefetch" href="/assets/js/34.4a07196d.js"><link rel="prefetch" href="/assets/js/35.7a226b76.js"><link rel="prefetch" href="/assets/js/36.db5eec9a.js"><link rel="prefetch" href="/assets/js/37.cdc338c4.js"><link rel="prefetch" href="/assets/js/38.34a35d7d.js"><link rel="prefetch" href="/assets/js/39.695deec3.js"><link rel="prefetch" href="/assets/js/4.7aa51947.js"><link rel="prefetch" href="/assets/js/40.f1dc7d30.js"><link rel="prefetch" href="/assets/js/41.1d34bbf6.js"><link rel="prefetch" href="/assets/js/42.423d3ca5.js"><link rel="prefetch" href="/assets/js/43.d353af94.js"><link rel="prefetch" href="/assets/js/44.de7ee57e.js"><link rel="prefetch" href="/assets/js/45.a6e7ec4a.js"><link rel="prefetch" href="/assets/js/46.2781428a.js"><link rel="prefetch" href="/assets/js/47.12910615.js"><link rel="prefetch" href="/assets/js/48.ec325e20.js"><link rel="prefetch" href="/assets/js/49.7e6b0e34.js"><link rel="prefetch" href="/assets/js/5.34d295cb.js"><link rel="prefetch" href="/assets/js/50.686eceeb.js"><link rel="prefetch" href="/assets/js/51.813c0a41.js"><link rel="prefetch" href="/assets/js/52.ef636f45.js"><link rel="prefetch" href="/assets/js/53.4c0b4978.js"><link rel="prefetch" href="/assets/js/54.6f9c7b33.js"><link rel="prefetch" href="/assets/js/55.4fc94690.js"><link rel="prefetch" href="/assets/js/56.1999815f.js"><link rel="prefetch" href="/assets/js/57.4678e399.js"><link rel="prefetch" href="/assets/js/58.60bc5f58.js"><link rel="prefetch" href="/assets/js/59.a600a8bd.js"><link rel="prefetch" href="/assets/js/6.dccabf12.js"><link rel="prefetch" href="/assets/js/60.7064c1b5.js"><link rel="prefetch" href="/assets/js/61.321797c3.js"><link rel="prefetch" href="/assets/js/62.29b63639.js"><link rel="prefetch" href="/assets/js/7.46fb0051.js"><link rel="prefetch" href="/assets/js/8.adc2b779.js"><link rel="prefetch" href="/assets/js/9.c180848b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f637169d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Pan's Blog</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Object-C</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/oc/runtime/" class="nav-link router-link-active">Runtime</a></li><li class="dropdown-item"><!----> <a href="/oc/kvo/" class="nav-link">KVO</a></li><li class="dropdown-item"><!----> <a href="/oc/runloop/" class="nav-link">RunLoop</a></li><li class="dropdown-item"><!----> <a href="/oc/other/" class="nav-link">Other</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Swift</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/swift/" class="nav-link">Swift4.2</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">C/C++</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/c/" class="nav-link">C/C++</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Multi-Platform</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Native Group</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/h5/flutter/" class="nav-link">Flutter</a></li><li class="dropdown-subitem"><a href="/h5/swiftui/" class="nav-link">SwiftUI</a></li><li class="dropdown-subitem"><a href="/h5/reactnative/" class="nav-link">React-native</a></li><li class="dropdown-subitem"><a href="/h5/cordova/" class="nav-link">Cordova</a></li><li class="dropdown-subitem"><a href="/h5/weex/" class="nav-link">Weex</a></li></ul></li><li class="dropdown-item"><h4>Web Group</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/h5/html/" class="nav-link">HTML</a></li><li class="dropdown-subitem"><a href="/h5/css/" class="nav-link">CSS</a></li><li class="dropdown-subitem"><a href="/h5/js/" class="nav-link">JS</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/pan372728544" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Object-C</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/oc/runtime/" class="nav-link router-link-active">Runtime</a></li><li class="dropdown-item"><!----> <a href="/oc/kvo/" class="nav-link">KVO</a></li><li class="dropdown-item"><!----> <a href="/oc/runloop/" class="nav-link">RunLoop</a></li><li class="dropdown-item"><!----> <a href="/oc/other/" class="nav-link">Other</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Swift</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/swift/" class="nav-link">Swift4.2</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">C/C++</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/c/" class="nav-link">C/C++</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">Multi-Platform</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Native Group</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/h5/flutter/" class="nav-link">Flutter</a></li><li class="dropdown-subitem"><a href="/h5/swiftui/" class="nav-link">SwiftUI</a></li><li class="dropdown-subitem"><a href="/h5/reactnative/" class="nav-link">React-native</a></li><li class="dropdown-subitem"><a href="/h5/cordova/" class="nav-link">Cordova</a></li><li class="dropdown-subitem"><a href="/h5/weex/" class="nav-link">Weex</a></li></ul></li><li class="dropdown-item"><h4>Web Group</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/h5/html/" class="nav-link">HTML</a></li><li class="dropdown-subitem"><a href="/h5/css/" class="nav-link">CSS</a></li><li class="dropdown-subitem"><a href="/h5/js/" class="nav-link">JS</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/pan372728544" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>Object-c之isa指针</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Object-c之对象的本质</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Object-c之RunLoop</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>Object-c之Category</span> <span class="arrow down"></span></p> <ul class="sidebar-group-items"><li><a href="/oc/runtime/category.html" class="active sidebar-link">Object-C - Category的本质</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/oc/runtime/category.html#category的本质" class="sidebar-link">Category的本质</a></li><li class="sidebar-sub-header"><a href="/oc/runtime/category.html#分类的底层结构" class="sidebar-link">分类的底层结构</a></li><li class="sidebar-sub-header"><a href="/oc/runtime/category.html#load-和-initialize" class="sidebar-link">load 和 initialize</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Object-c之关联对象</span> <span class="arrow right"></span></p> <!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>Object-c之Block本质</span> <span class="arrow right"></span></p> <!----></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="object-c-category的本质"><a href="#object-c-category的本质" aria-hidden="true" class="header-anchor">#</a> Object-C - Category的本质</h1> <ul><li><strong>Category的实现原理，以及Category为什么只能加方法不能加属性。</strong></li> <li><strong>Category中有load方法吗？load方法是什么时候调用的？load 方法能继承吗？</strong></li> <li><strong>load、initialize的区别，以及它们在category重写的时候的调用的次序。</strong></li></ul> <h2 id="category的本质"><a href="#category的本质" aria-hidden="true" class="header-anchor">#</a> Category的本质</h2> <p>首先我们写一段简单的代码，之后的分析都基于这段代码。</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token builtin">Presen</span>类 
<span class="token comment">// Presen.h</span>
#<span class="token keyword">import</span> <span class="token operator">&lt;</span><span class="token builtin">Foundation</span><span class="token operator">/</span><span class="token builtin">Foundation</span><span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
@interface <span class="token class-name">Preson</span> <span class="token punctuation">:</span> <span class="token builtin">NSObject</span>
<span class="token punctuation">{</span>
    int _age<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>run<span class="token punctuation">;</span>
@end

<span class="token comment">// Presen.m</span>
#<span class="token keyword">import</span> <span class="token string">&quot;Preson.h&quot;</span>
@implementation <span class="token builtin">Preson</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>run
<span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;Person - run&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@end

<span class="token builtin">Presen</span>扩展<span class="token number">1</span>
<span class="token comment">// Presen+Test.h</span>
#<span class="token keyword">import</span> <span class="token string">&quot;Preson.h&quot;</span>
@interface <span class="token class-name">Preson</span> <span class="token punctuation">(</span><span class="token builtin">Test</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token builtin">NSCopying</span><span class="token operator">&gt;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>test<span class="token punctuation">;</span>
<span class="token operator">+</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>abc<span class="token punctuation">;</span>
@property <span class="token punctuation">(</span>assign<span class="token punctuation">,</span> nonatomic<span class="token punctuation">)</span> int age<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>setAge<span class="token punctuation">:</span><span class="token punctuation">(</span>int<span class="token punctuation">)</span>age<span class="token punctuation">;</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span>age<span class="token punctuation">;</span>
@end

<span class="token comment">// Presen+Test.m</span>
#<span class="token keyword">import</span> <span class="token string">&quot;Preson+Test.h&quot;</span>
@implementation <span class="token builtin">Preson</span> <span class="token punctuation">(</span><span class="token builtin">Test</span><span class="token punctuation">)</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>test
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token operator">+</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>abc
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>setAge<span class="token punctuation">:</span><span class="token punctuation">(</span>int<span class="token punctuation">)</span>age
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>int<span class="token punctuation">)</span>age
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@end

<span class="token builtin">Presen</span>分类<span class="token number">2</span>
<span class="token comment">// Preson+Test2.h</span>
#<span class="token keyword">import</span> <span class="token string">&quot;Preson.h&quot;</span>
@interface <span class="token class-name">Preson</span> <span class="token punctuation">(</span><span class="token builtin">Test2</span><span class="token punctuation">)</span>
@end

<span class="token comment">// Preson+Test2.m</span>
#<span class="token keyword">import</span> <span class="token string">&quot;Preson+Test2.h&quot;</span>
@implementation <span class="token builtin">Preson</span> <span class="token punctuation">(</span><span class="token builtin">Test2</span><span class="token punctuation">)</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>run
<span class="token punctuation">{</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;Person (Test2) - run&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
@end

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><p>我们之前讲到过实例对象的isa指针指向类对象，类对象的isa指针指向元类对象，当p调用run方法时，通过实例对象的isa指针找到类对象，然后在类对象中查找对象方法，如果没有找到，就通过类对象的superclass指针找到父类对象，接着去寻找run方法。</p> <p><strong>那么当调用分类的方法时，步骤是否和调用对象方法一样呢？</strong>
分类中的对象方法依然是存储在类对象中的，同本类对象方法在同一个地方，调用步骤也同调用对象方法一样。如果是类方法的话，也同样是存储在元类对象中。
那么分类方法是如何存储在类对象中的，我们来通过源码看一下分类的底层结构。</p> <h2 id="分类的底层结构"><a href="#分类的底层结构" aria-hidden="true" class="header-anchor">#</a> 分类的底层结构</h2> <p><strong>如何验证上述问题？</strong>
通过查看分类的源码我们可以找到category_t 结构体。</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token keyword">struct</span> category_t <span class="token punctuation">{</span>
    const char <span class="token operator">*</span>name<span class="token punctuation">;</span>
    classref_t cls<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> method_list_t <span class="token operator">*</span>instanceMethods<span class="token punctuation">;</span> <span class="token comment">// 对象方法</span>
    <span class="token keyword">struct</span> method_list_t <span class="token operator">*</span>classMethods<span class="token punctuation">;</span> <span class="token comment">// 类方法</span>
    <span class="token keyword">struct</span> protocol_list_t <span class="token operator">*</span>protocols<span class="token punctuation">;</span> <span class="token comment">// 协议</span>
    <span class="token keyword">struct</span> property_list_t <span class="token operator">*</span>instanceProperties<span class="token punctuation">;</span> <span class="token comment">// 属性</span>
    <span class="token comment">// Fields below this point are not always present on disk.</span>
    <span class="token keyword">struct</span> property_list_t <span class="token operator">*</span>_classProperties<span class="token punctuation">;</span>

    method_list_t <span class="token operator">*</span><span class="token function">methodsForMeta</span><span class="token punctuation">(</span>bool isMeta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isMeta<span class="token punctuation">)</span> <span class="token keyword">return</span> classMethods<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> instanceMethods<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    property_list_t <span class="token operator">*</span><span class="token function">propertiesForMeta</span><span class="token punctuation">(</span>bool isMeta<span class="token punctuation">,</span> <span class="token keyword">struct</span> header_info <span class="token operator">*</span>hi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>从源码基本可以看出我们平时使用categroy的方式，对象方法，类方法，协议，和属性都可以找到对应的存储方式。并且我们发现分类结构体中是不存在成员变量的，因此分类中是不允许添加成员变量的。分类中添加的属性并不会帮助我们自动生成成员变量，只会生成get set方法的声明，需要我们自己去实现。
通过源码我们发现，分类的方法，协议，属性等好像确实是存放在categroy结构体里面的，那么他又是如何存储在类对象中的呢？
我们来看一下底层的内部方法探寻其中的原理。
首先我们通过命令行将Preson+Test.m文件转化为c++文件，查看其中的编译过程。</p> <div class="language-sh line-numbers-mode"><pre class="language-text"><code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc Preson+Test.m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在分类转化为c++文件中可以看出_category_t结构体中，存放着类名，对象方法列表，类方法列表，协议列表，以及属性列表。
<img src="/assets/img/22.dc012513.png" alt>
紧接着，我们可以看到_method_list_t类型的结构体，如下图所示
<img src="/assets/img/23.e481323b.png" alt></p> <p>上图中我们发现这个结构体 <strong><em>OBJC</em>$<em>CATEGORY_INSTANCE_METHODS_Preson</em>$_Test</strong> 从名称可以看出是 <strong>INSTANCE_METHODS</strong> 对象方法，并且一一对应为上面结构体内赋值。我们可以看到结构体中存储了方法占用的内存，方法数量，以及方法列表。并且从上图中找到分类中我们实现对应的对象方法，test , setAge, age三个方法
接下来我们发现同样的_method_list_t类型的类方法结构体，如下图所示
<img src="/assets/img/24.3c60ae4d.png" alt>
同上面对象方法列表一样，这个我们可以看出是类方法列表结构体 <strong><em>OBJC</em>$<em>CATEGORY_CLASS_METHODS_Preson</em>$_Test</strong>，同对象方法结构体相同，同样可以看到我们实现的类方法，abc。</p> <p><strong>接下来是协议方法列表</strong> <img src="/assets/img/25.046d8377.png" alt>
通过上述源码可以看到先将协议方法通过_method_list_t结构体存储，之后通过_protocol_t结构体存储在 <strong><em>OBJC_CATEGORY_PROTOCOLS</em>$<em>Preson</em>$_Test</strong> 中同_protocol_list_t结构体一一对应，分别为protocol_count 协议数量以及存储了协议方法的_protocol_t结构体。
最后我们可以看到属性列表
<img src="/assets/img/26.31961a30.png" alt>
属性列表结构体 <strong><em>OBJC</em>$<em>PROP_LIST_Preson</em>$_Test</strong> 同_prop_list_t结构体对应，存储属性的占用空间，属性属性数量，以及属性列表，从上图中可以看到我们自己写的age属性。
最后我们可以看到定义了 <strong><em>OBJC</em>$<em>CATEGORY_Preson</em>$_Test</strong> 结构体，并且将我们上面着重分析的结构体一一赋值，我们通过两张图片对照一下。
<img src="/assets/img/27.3d3abc87.png" alt> <img src="/assets/img/28.29961ae6.png" alt>
上下两张图一一对应，并且我们看到定义_class_t类型的 <strong>OBJC_CLASS_$_Preson</strong> 结构体，最后将 <strong><em>OBJC</em>$<em>CATEGORY_Preson</em>$_Test</strong> 的cls指针指向 <strong>OBJC_CLASS_$_Preson</strong> 结构体地址。我们这里可以看出，cls指针指向的应该是分类的主类类对象的地址。
通过以上分析我们发现。分类源码中确实是将我们定义的对象方法，类方法，属性等都存放在catagory_t结构体中。接下来我们在回到runtime源码查看catagory_t存储的方法，属性，协议等是如何存储在类对象中的。
首先来到runtime初始化函数
<img src="/assets/img/29.00e2d840.png" alt></p> <p>接着我们来到 &amp;map_images读取模块（images这里代表模块），来到map_images_nolock函数中找到_read_images函数，在_read_images函数中我们找到分类相关代码</p> <p><img src="/assets/img/30.4d4d3a47.png" alt></p> <p>从上述代码中我们可以知道这段代码是用来查找有没有分类的。通过_getObjc2CategoryList函数获取到分类列表之后，进行遍历，获取其中的方法，协议，属性等。可以看到最终都调用了remethodizeClass(cls);函数。我们来到remethodizeClass(cls);函数内部查看。</p> <p><img src="/assets/img/31.056a9e0c.png" alt></p> <p>通过上述代码我们发现attachCategories函数接收了类对象cls和分类数组cats，如我们一开始写的代码所示，一个类可以有多个分类。之前我们说到分类信息存储在category_t结构体中，那么多个分类则保存在category_list中。</p> <p><strong>我们来到attachCategories函数内部。</strong> <img src="/assets/img/32.e4f56f2d.png" alt>
上述源码中可以看出，首先根据方法列表，属性列表，协议列表，malloc分配内存，根据多少个分类以及每一块方法需要多少内存来分配相应的内存地址。之后从分类数组里面往三个数组里面存放分类数组里面存放的分类方法，属性以及协议放入对应mlist、proplists、protolosts数组中，这三个数组放着所有分类的方法，属性和协议。
之后通过类对象的data()方法，拿到类对象的class_rw_t结构体rw，在class结构中我们介绍过，class_rw_t中存放着类对象的方法，属性和协议等数据，rw结构体通过类对象的data方法获取，所以rw里面存放这类对象里面的数据。
之后分别通过rw调用方法列表、属性列表、协议列表的attachList函数，将所有的分类的方法、属性、协议列表数组传进去，我们大致可以猜想到在attachList方法内部将分类和本类相应的对象方法，属性，和协议进行了合并。</p> <p><strong>我们来看一下attachLists函数内部。</strong> <img src="/assets/img/33.4c84a332.png" alt>
上述源代码中有两个重要的数组
array()-&gt;lists： 类对象原来的方法列表，属性列表，协议列表。
addedLists：传入所有分类的方法列表，属性列表，协议列表。
attachLists函数中最重要的两个方法为memmove内存移动和memcpy内存拷贝。</p> <p><strong>我们先来分别看一下这两个函数</strong></p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token comment">// memmove ：内存移动。</span>
<span class="token comment">/*  __dst : 移动内存的目的地
*   __src : 被移动的内存首地址
*   __len : 被移动的内存长度
*   将__src的内存移动__len块内存到__dst中
*/</span>
void    <span class="token operator">*</span><span class="token function">memmove</span><span class="token punctuation">(</span>void <span class="token operator">*</span>__dst<span class="token punctuation">,</span> const void <span class="token operator">*</span>__src<span class="token punctuation">,</span> size_t __len<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// memcpy ：内存拷贝。</span>
<span class="token comment">/*  __dst : 拷贝内存的拷贝目的地
*   __src : 被拷贝的内存首地址
*   __n : 被移动的内存长度
*   将__src的内存移动__n块内存到__dst中
*/</span>
void    <span class="token operator">*</span><span class="token function">memcpy</span><span class="token punctuation">(</span>void <span class="token operator">*</span>__dst<span class="token punctuation">,</span> const void <span class="token operator">*</span>__src<span class="token punctuation">,</span> size_t __n<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><img src="/assets/img/35.78d1bab3.png" alt></p> <p>经过memmove方法之后，我们发现，虽然本类的方法，属性，协议列表会分别后移，但是本类的对应数组的指针依然指向原始位置。</p> <p>memcpy方法之后，内存变化
<img src="/assets/img/36.e463759f.png" alt>
我们发现原来指针并没有改变，至始至终指向开头的位置。并且经过memmove和memcpy方法之后，分类的方法，属性，协议列表被放在了类对象中原本存储的方法，属性，协议列表前面。
那么为什么要将分类方法的列表追加到本来的对象方法前面呢，这样做的目的是为了保证分类方法优先调用，我们知道当分类重写本类的方法时，会覆盖本类的方法。
其实经过上面的分析我们知道本质上并不是覆盖，而是优先调用。本类的方法依然在内存中的。我们可以通过打印所有类的所有方法名来查看</p> <div class="language-swift line-numbers-mode"><pre class="language-swift"><code><span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>printMethodNamesOfClass<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token builtin">Class</span><span class="token punctuation">)</span>cls
<span class="token punctuation">{</span>
    unsigned int <span class="token builtin">count</span><span class="token punctuation">;</span>
    <span class="token comment">// 获得方法数组</span>
    <span class="token builtin">Method</span> <span class="token operator">*</span>methodList <span class="token operator">=</span> <span class="token function">class_copyMethodList</span><span class="token punctuation">(</span>cls<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token builtin">count</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 存储方法名</span>
    <span class="token builtin">NSMutableString</span> <span class="token operator">*</span>methodNames <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">NSMutableString</span> string<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历所有的方法</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token builtin">count</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获得方法</span>
        <span class="token builtin">Method</span> method <span class="token operator">=</span> methodList<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// 获得方法名</span>
        <span class="token builtin">NSString</span> <span class="token operator">*</span>methodName <span class="token operator">=</span> <span class="token function">NSStringFromSelector</span><span class="token punctuation">(</span><span class="token function">method_getName</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拼接方法名</span>
        <span class="token punctuation">[</span>methodNames appendString<span class="token punctuation">:</span>methodName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">[</span>methodNames appendString<span class="token punctuation">:</span>@<span class="token string">&quot;, &quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 释放</span>
    <span class="token function">free</span><span class="token punctuation">(</span>methodList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 打印方法名</span>
    <span class="token function">NSLog</span><span class="token punctuation">(</span>@<span class="token string">&quot;%@ - %@&quot;</span><span class="token punctuation">,</span> cls<span class="token punctuation">,</span> methodNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">-</span> <span class="token punctuation">(</span>void<span class="token punctuation">)</span>viewDidLoad <span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token keyword">super</span> viewDidLoad<span class="token punctuation">]</span><span class="token punctuation">;</span>    
    <span class="token builtin">Preson</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">Preson</span> alloc<span class="token punctuation">]</span> <span class="token keyword">init</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>p run<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span><span class="token keyword">self</span> printMethodNamesOfClass<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token builtin">Preson</span> <span class="token keyword">class</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>通过下图中打印内容可以发现，调用的是Test2中的run方法，并且Person类中存储着两个run方法。
<img src="/assets/img/37.e938e2c9.png" alt></p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p><strong>总结：</strong></p> <ul><li>问： Category的实现原理，以及Category为什么只能加方法不能加属性?</li> <li>答：分类的实现原理是将category中的方法，属性，协议数据放在category_t结构体中，然后将结构体内的方法列表拷贝到类对象的方法列表中。
Category可以添加属性，但是并不会自动生成成员变量及set/get方法。因为category_t结构体中并不存在成员变量。通过之前对对象的分析我们知道成员变量是存放在实例对象中的，并且编译的那一刻就已经决定好了。而分类是在运行时才去加载的。那么我们就无法再程序运行时将分类的成员变量中添加到实例对象的结构体中。因此分类中不可以添加成员变量。</li></ul></div> <h2 id="load-和-initialize"><a href="#load-和-initialize" aria-hidden="true" class="header-anchor">#</a> load 和 initialize</h2> <p>load方法会在程序启动就会调用，当装载类信息的时候就会调用。
调用顺序看一下源代码。
<img src="/assets/img/38.c5c2e942.png" alt>
通过源码我们发现是优先调用类的load方法，之后调用分类的load方法。</p> <p>我们通过代码验证一下：
我们添加Student继承Presen类，并添加Student+Test分类，分别重写只+load方法，其他什么都不做通过打印发现
<img src="/assets/img/39.c3abb4ce.png" alt>
确实是优先调用类的load方法之后调用分类的load方法，不过调用类的load方法之前会保证其父类已经调用过load方法。</p> <p>之后我们为Preson、Student 、Student+Test 添加initialize方法。
我们知道当类第一次接收到消息时，就会调用initialize，相当于第一次使用类的时候就会调用initialize方法。调用子类的initialize之前，会先保证调用父类的initialize方法。如果之前已经调用过initialize，就不会再调用initialize方法了。当分类重写initialize方法时会先调用分类的方法。但是load方法并不会被覆盖，首先我们来看一下initialize的源码。</p> <p><img src="/assets/img/40.5a9ef9f4.png" alt></p> <p>上图中我们发现，initialize是通过消息发送机制调用的，消息发送机制通过isa指针找到对应的方法与实现，因此先找到分类方法中的实现，会优先调用分类方法中的实现。</p> <p>我们再来看一下load方法的调用源码</p> <p><img src="/assets/img/41.08bf325d.png" alt></p> <p>我们看到load方法中直接拿到load方法的内存地址直接调用方法，不在是通过消息发送机制调用。</p> <p><img src="/assets/img/42.2243b659.png" alt></p> <p>我们可以看到分类中也是通过直接拿到load方法的地址进行调用。因此正如我们之前试验的一样，分类中重写load方法，并不会优先调用分类的load方法，而不调用本类中的load方法了。</p> <p><strong>总结</strong></p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <ul><li>问：Category中有load方法吗？load方法是什么时候调用的？load 方法能继承吗？</li> <li>答：Category中有load方法，load方法在程序启动装载类信息的时候就会调用。load方法可以继承。调用子类的load方法之前，会先调用父类的load方法</li> <li>问：load、initialize的区别，以及它们在category重写的时候的调用的次序。</li> <li>答：区别在于调用方式和调用时刻
调用方式：load是根据函数地址直接调用，initialize是通过objc_msgSend调用
调用时刻：load是runtime加载类、分类的时候调用（只会调用1次），initialize是类第一次接收到消息的时候调用，每一个类只会initialize一次（父类的initialize方法可能会被调用多次）
调用顺序：先调用类的load方法，先编译那个类，就先调用load。在调用load之前会先调用父类的load方法。分类中load方法不会覆盖本类的load方法，先编译的分类优先调用load方法。initialize先初始化父类，之后再初始化子类。如果子类没有实现+initialize，会调用父类的+initialize（所以父类的+initialize可能会被调用多次），如果分类实现了+initialize，就覆盖类本身的+initialize调用。</li></ul></div></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">1/3/2019, 3:02:36 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/oc/runtime/runloop.html" class="prev">
          Object-C - Runloop
        </a></span> <span class="next"><a href="/oc/runtime/assoc.html">
          Object-C - 关联对象实现原理
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.908dfad3.js" defer></script><script src="/assets/js/3.fc5cd66f.js" defer></script>
  </body>
</html>
